import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  onSnapshot, 
  deleteDoc, 
  query 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  Search, 
  Plus, 
  Trash2, 
  MessageSquare, 
  Sparkles, 
  Copy, 
  Save, 
  X,
  Home,
  Database,
  Send,
  Loader2,
  Edit3,
  CheckCircle2,
  Cloud,
  FileUp,
  AlertCircle,
  CloudOff
} from 'lucide-react';

// --- KONFIGURASI FIREBASE ASISTENQNA ---
const firebaseConfig = {
  apiKey: "AIzaSyD7cc7bINhjzEEs4cRs8aM2nVPRrp-P1es",
  authDomain: "asistenqna.firebaseapp.com",
  projectId: "asistenqna",
  storageBucket: "asistenqna.firebasestorage.app",
  messagingSenderId: "841717936963",
  appId: "1:841717936963:web:6aa8e3d3e551d346f835f6",
  measurementId: "G-QXLKE9GDRD"
};

// Inisialisasi Firebase secara aman
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const appId = 'villa-assist-v1';

// Komponen Icon Wanita (Avatar SVG)
const FemaleAvatarIcon = () => (
  <svg viewBox="0 0 24 24" className="w-10 h-10 drop-shadow-sm" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="12" cy="12" r="12" fill="#E0E7FF"/>
    <path d="M12 14C14.2091 14 16 12.2091 16 10C16 7.79086 14.2091 6 12 6C9.79086 6 8 7.79086 8 10C8 12.2091 9.79086 14 12 14Z" fill="#6366F1"/>
    <path d="M12 15C8.68629 15 6 17.6863 6 21H18C18 17.6863 15.3137 15 12 15Z" fill="#4F46E5"/>
    <path d="M12 5C10.5 5 9 6.5 8.5 8C8 9.5 8.5 11 8.5 11C8.5 11 9 10 10 9.5C11 9 12 9 13 9.5C14 10 14.5 11 14.5 11C14.5 11 15 9.5 14.5 8C14 6.5 12.5 5 12 5Z" fill="#312E81"/>
  </svg>
);

const App = () => {
  const [faqs, setFaqs] = useState([]);
  const [user, setUser] = useState(null);
  const [authError, setAuthError] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [aiResponse, setAiResponse] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [entryForm, setEntryForm] = useState({ question: '', answer: '' });
  const [activeTab, setActiveTab] = useState('chat');
  const [isLoadingData, setIsLoadingData] = useState(true);
  const [importStatus, setImportStatus] = useState({ loading: false, message: '' });
  
  const fileInputRef = useRef(null);
  const apiKey = ""; // Masukkan API Key Gemini Anda di sini

  // Efek Autentikasi
  useEffect(() => {
    let isMounted = true;
    const initAuth = async () => {
      try {
        const result = await signInAnonymously(auth);
        if (isMounted) {
            console.log("Logged in as:", result.user.uid);
            setAuthError(null);
        }
      } catch (error) {
        if (isMounted) {
            if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
              setAuthError("Anonymous Sign-in belum aktif di Firebase Console.");
            } else {
              setAuthError(error.message);
            }
        }
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      if (isMounted) {
        setUser(currentUser);
        if (currentUser) setAuthError(null);
      }
    });
    return () => {
      isMounted = false;
      unsubscribe();
    };
  }, []);

  // Sinkronisasi Firestore
  useEffect(() => {
    if (!user) return;
    const faqCollection = collection(db, 'artifacts', appId, 'public', 'data', 'faqs');
    const q = query(faqCollection);
    const unsubscribe = onSnapshot(q, 
      (snapshot) => {
        const items = [];
        snapshot.forEach((doc) => {
          items.push({ id: doc.id, ...doc.data() });
        });
        setFaqs(items);
        setIsLoadingData(false);
      },
      (error) => {
        console.error("Firestore error:", error);
        setIsLoadingData(false);
      }
    );
    return () => unsubscribe();
  }, [user]);

  const filteredFaqs = useMemo(() => {
    if (!searchQuery.trim()) return [];
    const queryLower = searchQuery.toLowerCase();
    const queryWords = queryLower.split(/\s+/).filter(w => w.length > 2);

    return faqs.map(faq => {
      const target = (faq.question + " " + faq.answer).toLowerCase();
      let score = 0;
      if (target.includes(queryLower)) score += 100;
      queryWords.forEach(word => {
        if (target.includes(word)) score += 20;
      });
      return { ...faq, score };
    })
    .filter(faq => faq.score > 0)
    .sort((a, b) => b.score - a.score);
  }, [faqs, searchQuery]);

  const getAiSuggestion = async (queryText) => {
    if (!queryText || !apiKey) return;
    setIsGenerating(true);
    setAiResponse('');
    const systemPrompt = `Anda asisten admin villa. Gunakan data: ${JSON.stringify(faqs)}. Jawab sopan.`;
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: queryText }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] }
        })
      });
      const data = await response.json();
      setAiResponse(data.candidates?.[0]?.content?.parts?.[0]?.text || "Gagal membuat saran.");
    } catch (error) {
      setAiResponse("Kesalahan pada AI.");
    }
    setIsGenerating(false);
  };

  const handleCopy = (text) => {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
  };

  const handleSubmit = async () => {
    if (!user || !entryForm.question || !entryForm.answer) return;
    try {
      const id = editingId || Date.now().toString();
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'faqs', id);
      await setDoc(docRef, {
        question: entryForm.question,
        answer: entryForm.answer,
        updatedAt: new Date().toISOString()
      });
      closeModal();
    } catch (error) {
      console.error("Save error:", error);
    }
  };

  const deleteFaq = async (id) => {
    if (!user) return;
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'faqs', id);
      await deleteDoc(docRef);
    } catch (error) {
      console.error("Delete error:", error);
    }
  };

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    setImportStatus({ loading: true, message: 'Memproses CSV...' });
    const reader = new FileReader();
    reader.onload = async (e) => {
      const text = e.target.result;
      const lines = text.split('\n');
      const dataToImport = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split(',');
        if (parts.length >= 2) {
          dataToImport.push({
            question: parts[0].replace(/^"|"$/g, '').trim(),
            answer: parts.slice(1).join(',').replace(/^"|"$/g, '').trim()
          });
        }
      }
      try {
        for (const item of dataToImport) {
          const id = Date.now().toString() + Math.random().toString(36).substring(7);
          const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'faqs', id);
          await setDoc(docRef, { ...item, updatedAt: new Date().toISOString() });
        }
        setImportStatus({ loading: false, message: `Berhasil mengimpor ${dataToImport.length} data!` });
      } catch (error) {
        setImportStatus({ loading: false, message: 'Gagal impor.' });
      }
    };
    reader.readAsText(file);
  };

  const closeModal = () => {
    setIsModalOpen(false);
    setEditingId(null);
    setEntryForm({ question: '', answer: '' });
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
      {/* Banner Error Utama */}
      {authError && (
        <div className="bg-red-600 text-white px-6 py-4 flex items-center justify-between text-sm shadow-lg sticky top-0 z-50">
          <div className="flex items-center gap-3">
            <AlertCircle size={22} className="shrink-0" />
            <div>
              <p className="font-bold">Konfigurasi Firebase Tidak Lengkap</p>
              <p className="opacity-90">{authError}</p>
            </div>
          </div>
          <div className="flex gap-4 items-center">
            <a href="https://console.firebase.google.com/" target="_blank" rel="noreferrer" className="bg-white text-red-600 px-4 py-1.5 rounded-lg font-bold text-xs hover:bg-slate-100 transition-colors">Buka Console</a>
            <button onClick={() => window.location.reload()} className="p-1 hover:bg-white/20 rounded-full transition-colors"><X size={18} /></button>
          </div>
        </div>
      )}

      <nav className="bg-white border-b sticky top-0 z-10 px-6 py-4 flex justify-between items-center shadow-sm">
        <div className="flex items-center gap-4">
          {/* Ikon Wanita Cantik / Avatar */}
          <FemaleAvatarIcon />
          
          <div>
            <h1 className="text-xl font-bold tracking-tight flex items-center gap-2">
              VillaAssist <span className="text-indigo-600">Pro</span>
            </h1>
            <div className="flex items-center gap-1 text-[10px] font-bold uppercase tracking-tighter">
              {user ? (
                <span className="text-emerald-600 flex items-center gap-1"><Cloud size={10} /> Cloud Connected</span>
              ) : authError ? (
                <span className="text-red-500 flex items-center gap-1"><CloudOff size={10} /> Disconnected</span>
              ) : (
                <span className="text-amber-500 flex items-center gap-1"><Loader2 size={10} className="animate-spin" /> Authenticating...</span>
              )}
            </div>
          </div>
        </div>
        <div className="flex bg-slate-100 p-1 rounded-xl">
          <button onClick={() => setActiveTab('chat')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'chat' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-500'}`}>
            <MessageSquare size={16} className="inline mr-2" /> Chat
          </button>
          <button onClick={() => setActiveTab('database')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === 'database' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-500'}`}>
            <Database size={16} className="inline mr-2" /> Database
          </button>
        </div>
      </nav>

      <main className="max-w-6xl mx-auto p-6">
        {authError && !user ? (
          <div className="bg-white border-2 border-red-50 rounded-3xl p-12 text-center shadow-2xl max-w-2xl mx-auto mt-10">
            <div className="bg-red-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-8">
              <CloudOff size={48} className="text-red-500" />
            </div>
            <h2 className="text-3xl font-black text-slate-800 mb-4">Akses Database Ditolak</h2>
            <p className="text-slate-600 mb-8 leading-relaxed text-lg">
              Fitur <strong>Anonymous Sign-in</strong> belum dinyalakan di Firebase Console Anda.
            </p>
            <button onClick={() => window.location.reload()} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-2xl font-bold">Refresh Halaman</button>
          </div>
        ) : !user ? (
          <div className="flex flex-col items-center justify-center py-32 text-slate-400">
            <Loader2 size={48} className="animate-spin mb-6 text-indigo-600" />
            <p className="text-xl font-medium">Memverifikasi akses...</p>
          </div>
        ) : (
          <div className="animate-in fade-in slide-in-from-bottom-2 duration-500">
            {activeTab === 'chat' ? (
                <div className="space-y-6">
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                  <label className="block text-sm font-semibold mb-3 text-slate-700">Masukkan Pesan Tamu:</label>
                  <div className="relative group">
                    <textarea 
                      className="w-full p-4 pr-12 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all h-24 resize-none bg-slate-50/30"
                      placeholder="Contoh: Apakah villa ini ada kolam renang pribadinya?"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                    />
                    <button 
                      onClick={() => getAiSuggestion(searchQuery)}
                      disabled={!searchQuery || isGenerating}
                      className="absolute bottom-4 right-4 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white p-2 rounded-lg transition-colors shadow-lg"
                    >
                      {isGenerating ? <Loader2 size={20} className="animate-spin" /> : <Sparkles size={20} />}
                    </button>
                  </div>
                </div>
  
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <h3 className="font-bold text-slate-700 flex items-center gap-2 px-1 text-sm uppercase tracking-wider">
                      <Database size={16} className="text-slate-400" /> Kecocokan Database
                    </h3>
                    <div className="space-y-3 h-[450px] overflow-y-auto pr-2 custom-scrollbar">
                      {isLoadingData ? (
                        <div className="flex justify-center py-10"><Loader2 className="animate-spin text-slate-300" /></div>
                      ) : searchQuery && filteredFaqs.length > 0 ? (
                        filteredFaqs.map(faq => (
                          <div key={faq.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm group relative hover:border-indigo-300 hover:shadow-md transition-all">
                            <p className="text-[10px] font-black text-indigo-600 italic mb-1 uppercase tracking-tighter">DATA: {faq.question}</p>
                            <p className="text-sm text-slate-600 mb-3 leading-relaxed">{faq.answer}</p>
                            <button onClick={() => handleCopy(faq.answer)} className="w-full flex items-center justify-center gap-2 py-2 bg-slate-50 hover:bg-indigo-600 hover:text-white text-slate-600 rounded-lg text-xs font-bold border border-transparent transition-all">
                              <Copy size={14} /> Salin Jawaban Ini
                            </button>
                          </div>
                        ))
                      ) : (
                        <div className="flex flex-col items-center justify-center h-full text-slate-400 bg-white rounded-2xl border-2 border-dashed border-slate-100 text-center p-8">
                          <Search size={40} className="mb-4 opacity-10" />
                          <p className="text-sm font-medium">Hasil database muncul di sini.</p>
                        </div>
                      )}
                    </div>
                  </div>
  
                  <div className="space-y-4">
                    <h3 className="font-bold text-indigo-900 flex items-center gap-2 px-1 text-sm uppercase tracking-wider">
                      <Sparkles size={16} className="text-indigo-500" /> Rekomendasi Balasan AI
                    </h3>
                    <div className="bg-gradient-to-br from-indigo-50 to-white p-6 rounded-2xl border border-indigo-100 shadow-sm h-[450px] flex flex-col">
                      {isGenerating ? (
                        <div className="flex flex-col items-center justify-center h-full text-indigo-400 gap-3">
                          <Loader2 size={32} className="animate-spin" />
                          <p className="text-sm font-bold animate-pulse">Menghubungkan ke Gemini...</p>
                        </div>
                      ) : aiResponse ? (
                        <div className="flex flex-col h-full">
                          <div className="flex-1 overflow-y-auto text-sm text-slate-700 leading-relaxed whitespace-pre-wrap pr-2">
                            {aiResponse}
                          </div>
                          <button onClick={() => handleCopy(aiResponse)} className="mt-4 flex items-center justify-center gap-2 py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-black shadow-lg shadow-indigo-100 transition-all active:scale-95">
                            <Copy size={16} /> Salin Balasan AI
                          </button>
                        </div>
                      ) : (
                        <div className="flex flex-col items-center justify-center h-full text-slate-300 text-center px-4">
                          <Send size={40} className="mb-4 opacity-10" />
                          <p className="text-sm font-medium">Draft otomatis AI akan muncul di sini.</p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            ) : (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div className="p-6 border-b flex flex-wrap justify-between items-center bg-slate-50/50 gap-4">
                  <div className="flex-1">
                    <h2 className="text-lg font-black text-slate-800">Daftar FAQ & Ketentuan</h2>
                    <p className="text-sm text-slate-500 font-medium">Terhubung ke Cloud Database</p>
                  </div>
                  
                  <div className="flex items-center gap-2">
                    <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv" className="hidden" />
                    <button onClick={() => fileInputRef.current?.click()} className="flex items-center gap-2 bg-white hover:bg-slate-50 text-slate-700 px-4 py-2.5 rounded-xl border border-slate-200 transition-all text-sm font-bold">
                      <FileUp size={18} /> Import CSV
                    </button>
                    <button onClick={() => setIsModalOpen(true)} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl transition-all shadow-md text-sm font-bold">
                      <Plus size={18} /> Tambah Data
                    </button>
                  </div>
                </div>
  
                <div className="p-6">
                  <div className="relative mb-6">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                    <input type="text" placeholder="Cari pertanyaan di database..." className="w-full pl-10 pr-4 py-3.5 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                  </div>
                  <div className="overflow-x-auto border border-slate-100 rounded-xl">
                    <table className="w-full text-left">
                      <thead className="bg-slate-50/80">
                        <tr className="text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100">
                          <th className="py-4 px-6 w-1/3">Pertanyaan</th>
                          <th className="py-4 px-6">Jawaban</th>
                          <th className="py-4 px-6 text-right w-24">Aksi</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-50">
                        {isLoadingData ? (
                          <tr><td colSpan="3" className="py-12 text-center text-slate-400 font-medium"><Loader2 className="animate-spin inline mr-2 text-indigo-500" /> Memuat data...</td></tr>
                        ) : (
                          faqs.filter(f => f.question.toLowerCase().includes(searchQuery.toLowerCase())).map(faq => (
                            <tr key={faq.id} className="hover:bg-indigo-50/30 transition-colors group">
                              <td className="py-4 px-6 text-sm text-slate-700 font-bold">{faq.question}</td>
                              <td className="py-4 px-6 text-sm text-slate-500 max-w-xs truncate">{faq.answer}</td>
                              <td className="py-4 px-6 text-right whitespace-nowrap">
                                <div className="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onClick={() => { setEditingId(faq.id); setEntryForm({question: faq.question, answer: faq.answer}); setIsModalOpen(true); }} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-white rounded-lg"><Edit3 size={16} /></button>
                                    <button onClick={() => deleteFaq(faq.id)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-white rounded-lg"><Trash2 size={16} /></button>
                                </div>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
      </main>

      {/* Modal Add/Edit */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in-95 duration-200">
            <div className="p-8 border-b flex justify-between items-center bg-slate-50/50">
              <h3 className="text-xl font-black text-slate-800">{editingId ? "Perbarui Data" : "Tambah Data Baru"}</h3>
              <button onClick={closeModal} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><X size={20} className="text-slate-500" /></button>
            </div>
            <div className="p-8 space-y-6">
              <div>
                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Pertanyaan / Tema:</label>
                <input type="text" className="w-full p-4 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-500 bg-slate-50/50" value={entryForm.question} onChange={(e) => setEntryForm({...entryForm, question: e.target.value})} />
              </div>
              <div>
                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Jawaban Standar:</label>
                <textarea className="w-full p-4 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-500 h-40 resize-none bg-slate-50/50" value={entryForm.answer} onChange={(e) => setEntryForm({...entryForm, answer: e.target.value})} />
              </div>
            </div>
            <div className="p-8 bg-slate-50 border-t flex gap-4">
              <button onClick={closeModal} className="flex-1 py-4 font-black text-slate-500 bg-white border-2 border-slate-200 rounded-2xl">BATAL</button>
              <button onClick={handleSubmit} disabled={!user} className="flex-1 py-4 font-black bg-indigo-600 text-white rounded-2xl shadow-xl hover:bg-indigo-700 disabled:bg-slate-300">SIMPAN DATA</button>
            </div>
          </div>
        </div>
      )}

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6366f1; }
      `}</style>
    </div>
  );
};

export default App;
