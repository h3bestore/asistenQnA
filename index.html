<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VillaAssist Pro - Lestari Villa Puncak</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc;
            overflow-x: hidden;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { transform: scale(0.92); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.7s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-scale-in { animation: scaleIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-float { animation: float 4s ease-in-out infinite; }
        
        .stagger-1 { animation-delay: 100ms; }
        .stagger-2 { animation-delay: 200ms; }
        .stagger-3 { animation-delay: 300ms; }

        .hover-lift { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hover-lift:hover { transform: translateY(-4px); }
        .active-push:active { transform: scale(0.96); }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-900">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : {
            apiKey: "AIzaSyD7cc7bINhjzEEs4cRs8aM2nVPRrp-P1es",
            authDomain: "asistenqna.firebaseapp.com",
            projectId: "asistenqna",
            storageBucket: "asistenqna.firebasestorage.app",
            messagingSenderId: "841717936963",
            appId: "1:841717936963:web:6aa8e3d3e551d346f835f6",
        };

        const app = initializeApp(firebaseConfig);
        window.FB = {
            db: getFirestore(app),
            auth: getAuth(app),
            collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, writeBatch,
            signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'villa-assist-v1'
        };
        window.fb_initialized = true;
    </script>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, size = 16, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({
                        attrs: { class: className, 'stroke-width': 2 },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, className, size]);
            return <span className="inline-flex items-center justify-center"><i ref={iconRef} data-lucide={name} style={{ width: size, height: size }}></i></span>;
        };

        function App() {
            const [status, setStatus] = useState('connecting'); 
            const [user, setUser] = useState(null);
            const [faqs, setFaqs] = useState([]);
            const [search, setSearch] = useState("");
            const [aiResponse, setAiResponse] = useState("");
            const [loadingAI, setLoadingAI] = useState(false);
            const [tab, setTab] = useState("chat");
            const [formData, setFormData] = useState({ question: "", answer: "" });
            const [editingId, setEditingId] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const [showImport, setShowImport] = useState(false);
            const [importCsv, setImportCsv] = useState("");

            const apiKey = ""; 

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.FB) return;
                    const { auth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.FB;
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            if (u) setStatus('ready');
                        });
                    } catch (err) { setStatus('error'); }
                };

                const checkInterval = setInterval(() => {
                    if (window.fb_initialized) { clearInterval(checkInterval); initFirebase(); }
                }, 100);
                return () => clearInterval(checkInterval);
            }, []);

            useEffect(() => {
                if (status !== 'ready' || !user) return;
                const { db, collection, onSnapshot, appId } = window.FB;
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'faqs');
                const unsubscribe = onSnapshot(colRef, 
                    (snap) => setFaqs(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                    (err) => console.error("Sync error:", err)
                );
                return () => unsubscribe();
            }, [status, user]);

            const filteredFaqs = useMemo(() => {
                if (!search.trim()) return [];
                const q = search.toLowerCase();
                return faqs.filter(f => 
                    f.question?.toLowerCase().includes(q) || f.answer?.toLowerCase().includes(q)
                ).slice(0, 5);
            }, [faqs, search]);

            // Peningkatan stabilitas AI
            const generateAI = async () => {
                if (!search.trim()) return;
                setLoadingAI(true);
                setAiResponse("");

                const context = filteredFaqs.length > 0 
                    ? filteredFaqs.map(f => `Q: ${f.question} | A: ${f.answer}`).join("\n")
                    : "Lestari Villa Puncak, lokasi di Puncak.";

                const prompt = `Gunakan data ini: "${context}". Balas pertanyaan tamu: "${search}". Buat jawaban WhatsApp ramah dan sopan. Maksimal 3 kalimat.`;

                const fetchWithRetry = async (retries = 3, delay = 1000) => {
                    try {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), 15000); // 15 detik timeout

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            signal: controller.signal,
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                systemInstruction: { parts: [{ text: "Kamu adalah admin CS Lestari Villa Puncak. Balas dengan sangat sopan dan informatif." }] }
                            })
                        });
                        
                        clearTimeout(id);
                        
                        if (!response.ok) throw new Error("API Error");
                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text;
                    } catch (err) {
                        if (retries > 0) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return fetchWithRetry(retries - 1, delay * 2);
                        }
                        throw err;
                    }
                };

                try {
                    const result = await fetchWithRetry();
                    setAiResponse(result);
                } catch (err) {
                    console.error(err);
                    setAiResponse("Koneksi ke AI terputus. Mohon pastikan internet stabil dan coba klik 'Generate Balasan' sekali lagi.");
                } finally {
                    setLoadingAI(false);
                }
            };

            const handleSave = async () => {
                const { db, doc, updateDoc, addDoc, collection, appId } = window.FB;
                const path = ['artifacts', appId, 'public', 'data', 'faqs'];
                if (editingId) {
                    await updateDoc(doc(db, ...path, editingId), formData);
                    setEditingId(null);
                } else {
                    await addDoc(collection(db, ...path), formData);
                    setIsAdding(false);
                }
                setFormData({ question: "", answer: "" });
            };

            const handleImportCsv = async () => {
                if (!importCsv.trim()) return;
                const { db, collection, doc, writeBatch, appId } = window.FB;
                const batch = writeBatch(db);
                const lines = importCsv.split('\n');
                let count = 0;
                lines.forEach((line, i) => {
                    if (!line.trim() || (i === 0 && line.toLowerCase().includes('question'))) return;
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        const question = parts[0].trim().replace(/^"|"$/g, '');
                        const answer = parts.slice(1).join(',').trim().replace(/^"|"$/g, '');
                        const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'faqs'));
                        batch.set(ref, { question, answer });
                        count++;
                    }
                });
                if (count > 0) {
                    await batch.commit();
                    setShowImport(false);
                    setImportCsv("");
                }
            };

            const copyToClipboard = (text) => {
                const tempTextArea = document.createElement("textarea");
                tempTextArea.value = text.replace(/\s+/g, ' ').trim();
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try { document.execCommand('copy'); } catch (err) {}
                document.body.removeChild(tempTextArea);
            };

            if (status === 'connecting') return (
                <div className="h-screen flex flex-col items-center justify-center bg-white animate-fade-in">
                    <div className="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-6"></div>
                    <p className="text-slate-400 font-bold tracking-widest uppercase text-[10px] animate-pulse">Menghubungkan Database...</p>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    <header className="bg-white/80 backdrop-blur-md border-b px-6 py-4 sticky top-0 z-50 shadow-sm animate-fade-in">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-4 group cursor-default">
                                <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200 hover-lift active-push animate-float">
                                    <Icon name="sparkles" size={20} />
                                </div>
                                <div>
                                    <h1 className="font-extrabold text-slate-900 tracking-tight transition-colors group-hover:text-indigo-600">VillaAssist Pro</h1>
                                    <div className="flex items-center gap-2">
                                        <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                                        <p className="text-[10px] text-slate-400 font-black uppercase tracking-widest">Lestari Villa Puncak</p>
                                    </div>
                                </div>
                            </div>
                            <div className="flex bg-slate-100 p-1 rounded-xl shadow-inner">
                                <button onClick={() => setTab("chat")} className={`px-6 py-2.5 rounded-lg text-xs font-bold transition-all duration-300 active-push ${tab === "chat" ? "bg-white shadow-md text-indigo-600" : "text-slate-500 hover:text-slate-800"}`}>ASISTEN</button>
                                <button onClick={() => setTab("db")} className={`px-6 py-2.5 rounded-lg text-xs font-bold transition-all duration-300 active-push ${tab === "db" ? "bg-white shadow-md text-indigo-600" : "text-slate-500 hover:text-slate-800"}`}>DATABASE</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto w-full p-6 space-y-8">
                        {tab === "chat" ? (
                            <div className="grid lg:grid-cols-12 gap-8 items-start">
                                <div className="lg:col-span-7 space-y-6 animate-slide-up">
                                    <div className="relative group overflow-hidden rounded-2xl">
                                        <div className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors">
                                            <Icon name="search" size={20} />
                                        </div>
                                        <input 
                                            className="w-full pl-14 pr-6 py-5 rounded-2xl border-2 border-white bg-white shadow-xl shadow-slate-200/50 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/5 transition-all text-sm font-medium"
                                            placeholder="Cari pertanyaan tamu di sini..."
                                            value={search}
                                            onChange={(e) => setSearch(e.target.value)}
                                        />
                                    </div>
                                    <div className="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100 min-h-[400px]">
                                        <div className="flex items-center gap-2 mb-8 animate-fade-in">
                                            <div className="p-1.5 bg-slate-50 rounded-lg"><Icon name="database" size={16} className="text-slate-400" /></div>
                                            <span className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em]">Database Cocok</span>
                                        </div>
                                        <div className="space-y-4">
                                            {filteredFaqs.length > 0 ? filteredFaqs.map((f, i) => (
                                                <div key={f.id} className={`p-6 rounded-2xl bg-slate-50 border border-slate-100 animate-scale-in stagger-${i+1} hover:border-indigo-200 hover:bg-indigo-50/30 transition-all duration-300 group`}>
                                                    <p className="font-bold text-slate-800 text-sm mb-2 group-hover:text-indigo-900 transition-colors">{f.question}</p>
                                                    <p className="text-xs text-slate-500 leading-relaxed mb-5">{f.answer}</p>
                                                    <button onClick={() => copyToClipboard(f.answer)} className="text-[10px] font-bold text-indigo-600 flex items-center gap-2 px-4 py-2.5 bg-white border border-indigo-100 rounded-xl hover:bg-indigo-600 hover:text-white transition-all active-push">
                                                        <Icon name="copy" size={12} /> SALIN KE WHATSAPP
                                                    </button>
                                                </div>
                                            )) : (
                                                <div className="py-24 text-center text-slate-300">
                                                    <Icon name="message-square" size={48} className="mx-auto mb-4 opacity-10 animate-float" />
                                                    <p className="text-sm font-medium opacity-50">Ketik pertanyaan untuk melihat database</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div className="lg:col-span-5 animate-slide-up stagger-2">
                                    <div className="bg-indigo-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden group">
                                        <div className="absolute -top-10 -right-10 p-20 opacity-10 rotate-12 transition-transform group-hover:rotate-45 duration-700">
                                            <Icon name="sparkles" size={160} />
                                        </div>
                                        
                                        <div className="flex items-center gap-3 mb-10 relative z-10">
                                            <div className="p-2.5 bg-white/10 rounded-xl animate-float"><Icon name="cpu" size={20} /></div>
                                            <span className="text-[11px] font-black uppercase tracking-[0.3em] text-indigo-300">AI Composer</span>
                                        </div>

                                        <div className={`min-h-[220px] rounded-3xl p-7 mb-8 border transition-all duration-700 relative z-10 ${aiResponse ? "bg-white/10 border-white/20 animate-scale-in" : "bg-black/20 border-white/5 border-dashed"}`}>
                                            {loadingAI ? (
                                                <div className="h-full flex flex-col items-center justify-center py-12 gap-4">
                                                    <div className="flex gap-1.5">
                                                        <span className="w-2.5 h-2.5 bg-indigo-300 rounded-full animate-bounce"></span>
                                                        <span className="w-2.5 h-2.5 bg-indigo-300 rounded-full animate-bounce [animation-delay:0.2s]"></span>
                                                        <span className="w-2.5 h-2.5 bg-indigo-300 rounded-full animate-bounce [animation-delay:0.4s]"></span>
                                                    </div>
                                                    <p className="text-[10px] font-black uppercase tracking-widest text-indigo-400">Menyusun Kalimat...</p>
                                                </div>
                                            ) : (
                                                <p className="text-[13px] leading-relaxed text-indigo-50 font-medium">
                                                    {aiResponse || "AI akan membantu menyusun balasan yang sopan. Klik tombol di bawah setelah mencari pertanyaan."}
                                                </p>
                                            )}
                                        </div>

                                        <button 
                                            onClick={generateAI} 
                                            disabled={loadingAI || !search.trim()} 
                                            className="w-full py-5 bg-white text-indigo-950 font-black rounded-2xl hover:bg-indigo-50 hover:shadow-2xl active-push transition-all disabled:opacity-30 flex items-center justify-center gap-3 relative z-10 overflow-hidden group/btn"
                                        >
                                            <div className="absolute inset-0 bg-indigo-100 translate-y-full group-hover/btn:translate-y-0 transition-transform duration-300"></div>
                                            <span className="relative flex items-center gap-3">
                                                <Icon name="zap" size={18} className={loadingAI ? "animate-spin" : ""} /> 
                                                {loadingAI ? "SEDANG PROSES..." : "GENERATE BALASAN"}
                                            </span>
                                        </button>

                                        {aiResponse && (
                                            <button onClick={() => copyToClipboard(aiResponse)} className="w-full mt-5 py-4 text-xs font-bold text-indigo-200 border border-indigo-700/50 rounded-2xl hover:bg-white/5 hover:text-white transition-all active-push flex items-center justify-center gap-2">
                                                <Icon name="clipboard-check" size={14} /> SALIN HASIL AI
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100 animate-slide-up">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6 mb-12">
                                    <div>
                                        <h2 className="text-2xl font-black text-slate-900 tracking-tight">Knowledge Base</h2>
                                        <p className="text-sm text-slate-400 font-medium mt-1">Pusat data jawaban otomatis villa Anda.</p>
                                    </div>
                                    <div className="flex gap-3 w-full sm:w-auto">
                                        <button onClick={() => setShowImport(!showImport)} className={`p-4 rounded-xl border transition-all active-push ${showImport ? "bg-indigo-50 border-indigo-200 text-indigo-600" : "bg-slate-50 text-slate-500 border-slate-100 hover:bg-slate-100"}`}>
                                            <Icon name="upload" size={20} />
                                        </button>
                                        <button onClick={() => { setIsAdding(true); setEditingId(null); setFormData({question:"", answer:""}) }} className="flex-1 sm:flex-none px-8 py-4 bg-indigo-600 text-white font-black rounded-xl shadow-lg shadow-indigo-100 hover:bg-indigo-700 active-push transition-all flex items-center justify-center gap-2">
                                            <Icon name="plus" size={20} /> TAMBAH DATA
                                        </button>
                                    </div>
                                </div>

                                {showImport && (
                                    <div className="mb-10 p-8 bg-indigo-50/50 rounded-3xl border-2 border-dashed border-indigo-100 animate-scale-in">
                                        <textarea className="w-full p-5 rounded-2xl border border-indigo-100 bg-white h-40 text-sm outline-none mb-5 focus:ring-4 focus:ring-indigo-500/5 transition-all" placeholder="Import CSV: Pertanyaan, Jawaban" value={importCsv} onChange={e => setImportCsv(e.target.value)} />
                                        <div className="flex gap-3">
                                            <button onClick={handleImportCsv} className="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 active-push transition-all">PROSES IMPORT</button>
                                            <button onClick={() => setShowImport(false)} className="px-8 py-4 bg-white border border-indigo-100 text-indigo-600 font-bold rounded-xl hover:bg-indigo-50">BATAL</button>
                                        </div>
                                    </div>
                                )}

                                {(isAdding || editingId) && (
                                    <div className="mb-12 p-10 bg-slate-50 rounded-[2rem] border border-slate-200 animate-scale-in">
                                        <div className="grid gap-6">
                                            <input className="w-full p-5 rounded-2xl border border-slate-200 outline-none focus:border-indigo-500 font-bold text-sm" placeholder="Pertanyaan Tamu" value={formData.question} onChange={e => setFormData({...formData, question: e.target.value})} />
                                            <textarea className="w-full p-5 rounded-2xl border border-slate-200 outline-none focus:border-indigo-500 text-sm h-40" placeholder="Jawaban (Data)" value={formData.answer} onChange={e => setFormData({...formData, answer: e.target.value})} />
                                            <div className="flex gap-4">
                                                <button onClick={handleSave} className="flex-1 py-5 bg-slate-900 text-white font-black rounded-2xl hover:bg-black active-push transition-all">SIMPAN PERUBAHAN</button>
                                                <button onClick={() => { setIsAdding(false); setEditingId(null); }} className="px-10 py-5 bg-white text-slate-500 font-bold rounded-2xl border border-slate-200 hover:bg-slate-100 active-push">BATAL</button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="space-y-4">
                                    {faqs.length > 0 ? faqs.map((f, i) => (
                                        <div key={f.id} className="p-6 bg-white border border-slate-100 rounded-3xl flex justify-between items-center group animate-scale-in hover:shadow-xl hover:border-indigo-100 transition-all duration-300">
                                            <div className="flex-1 mr-6">
                                                <p className="font-extrabold text-slate-800 text-sm group-hover:text-indigo-600 transition-colors">{f.question}</p>
                                                <p className="text-xs text-slate-400 mt-1 line-clamp-1">{f.answer}</p>
                                            </div>
                                            <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                                <button onClick={() => { setEditingId(f.id); setFormData({question: f.question, answer: f.answer}); window.scrollTo({top:0, behavior:'smooth'}); }} className="p-3 text-indigo-500 bg-indigo-50 hover:bg-indigo-600 hover:text-white rounded-xl active-push"><Icon name="edit-3" size={18} /></button>
                                                <button onClick={() => { if(confirm("Hapus data ini?")) window.FB.deleteDoc(window.FB.doc(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'faqs', f.id)) }} className="p-3 text-rose-500 bg-rose-50 hover:bg-rose-600 hover:text-white rounded-xl active-push"><Icon name="trash-2" size={18} /></button>
                                            </div>
                                        </div>
                                    )) : <p className="text-center py-10 text-slate-300 font-bold">Database kosong.</p>}
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="py-12 text-center text-[10px] font-black text-slate-300 uppercase tracking-[0.4em]">
                        VillaAssist Pro &copy; 2024
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
